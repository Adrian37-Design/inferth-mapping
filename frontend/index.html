<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inferth Mapping - Fleet Tracking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="app.css">
    <link rel="stylesheet" href="users.css">
    <link rel="icon" type="image/png" href="logo.png">
    <script src="auth.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <img src="logo.png" alt="Inferth Logo" class="brand-logo">
            <span>Inferth Mapping</span>
            <span class="role-badge" id="user-role-display"></span>
        </div>
        <div class="nav-stats">
            <div class="stat-item">
                <i class="fas fa-circle" id="status-dot"></i>
                <span id="status-text">Connecting...</span>
            </div>
            <button class="logout-btn" id="logout-btn" title="Logout"
                onclick="window.AuthManager && window.AuthManager.logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tabbed Sidebar -->
        <aside class="sidebar-container" id="sidebar">
            <!-- Icon Rail -->
            <div class="sidebar-rail">
                <div class="rail-item active" data-tab="tab-fleet" title="Fleet">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="rail-item" data-tab="tab-analytics" title="Analytics">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="rail-item" data-tab="tab-alerts" title="Alerts">
                    <i class="fas fa-bell"></i>
                    <span class="rail-badge hidden" id="rail-alerts-count">0</span>
                </div>
                <div class="rail-item" data-tab="tab-users" title="Management" id="rail-users-btn">
                    <i class="fas fa-users-cog"></i>
                </div>
            </div>

            <!-- Panel Content -->
            <div class="sidebar-panel">
                <div class="panel-header">
                    <h3 id="panel-title">Fleet Overview</h3>
                    <button class="toggle-panel" id="toggle-sidebar-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>

                <!-- Tab: Fleet List -->
                <div id="tab-fleet" class="tab-content active">
                    <div class="action-bar">
                        <button class="btn-small" id="add-vehicle-sidebar"><i class="fas fa-plus"></i> Add</button>
                    </div>
                    <div class="vehicle-list" id="vehicle-list">
                        <p class="loading">Loading vehicles...</p>
                    </div>
                </div>

                <!-- Tab: Analytics -->
                <div id="tab-analytics" class="tab-content">
                    <div class="summary-card-sidebar">
                        <h4>Fleet Status</h4>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="value" id="summary-total">0</span>
                                <span class="label">Total</span>
                            </div>
                            <div class="summary-item">
                                <span class="value success" id="summary-online">0</span>
                                <span class="label">Online</span>
                            </div>
                            <div class="summary-item">
                                <span class="value danger" id="summary-offline">0</span>
                                <span class="label">Offline</span>
                            </div>
                        </div>
                    </div>
                    <hr class="panel-divider">
                    <div class="quick-stats">
                        <h4>Quick Actions</h4>
                        <button class="panel-btn" id="show-trips-sidebar"><i class="fas fa-history"></i> Trip
                            History</button>
                    </div>
                </div>

                <!-- Tab: Alerts -->
                <div id="tab-alerts" class="tab-content">
                    <div class="alert-controls">
                        <button class="btn-text" id="clear-alerts">Clear All</button>
                    </div>
                    <div id="alerts-list" class="sidebar-list">
                        <p class="empty-state">No new alerts</p>
                    </div>
                </div>

                <!-- Tab: Users -->
                <div id="tab-users" class="tab-content">
                    <div class="action-bar">
                        <button class="btn-small" id="invite-user-sidebar"
                            onclick="document.getElementById('user-form-modal').classList.remove('hidden')"><i
                                class="fas fa-user-plus"></i>
                            Invite</button>
                    </div>
                    <div id="users-list" class="users-list">
                        <p class="loading">Loading users...</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map Container -->
        <div class="map-wrapper">
            <div id="map"></div>

            <!-- Dashboard Summary REMOVED (Moved to Sidebar) -->

            <!-- Route Controls (Hidden by default) -->
            <div class="route-controls hidden" id="route-controls">
                <button class="control-btn" id="play-route" title="Play Route">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="pause-route" title="Pause">
                    <i class="fas fa-pause"></i>
                </button>
                <button class="control-btn" id="stop-route" title="Stop">
                    <i class="fas fa-stop"></i>
                </button>
                <div class="speed-control">
                    <label>Speed: <span id="speed-value">1x</span></label>
                    <input type="range" id="playback-speed" min="1" max="10" value="1">
                </div>
            </div>
        </div>

        <!-- Floating Action Buttons -->
        <!-- Only map-specific tools remain -->
        <div class="fab-container">
            <button class="fab" id="center-map" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
        </div>
    </div>

    <!-- Modals (Simplified) -->
    <!-- Invite/Edit User Modal only needed for form input, list is now in sidebar -->
    <div class="modal hidden" id="user-form-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Invite User</h3>
                <button class="close-modal" id="close-user-form">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="invite-user-form">
                    <div class="form-group">
                        <input type="email" id="invite-email" placeholder="Email Address" required>
                    </div>
                    <div class="form-group">
                        <select id="invite-role">
                            <option value="viewer">Viewer</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Send Invite</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal hidden" id="edit-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Edit User</h3>
                <button class="close-modal" id="close-edit-user">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    <div class="form-group">
                        <label>User</label>
                        <input type="text" id="edit-user-email" disabled>
                    </div>
                    <div class="form-group">
                        <label for="edit-user-role">Role</label>
                        <select id="edit-user-role" required>
                            <option value="viewer">Viewer</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancel-edit-user">Cancel</button>
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Trip History Modal -->
    <div class="modal hidden" id="trip-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Trip History</h3>
                <button class="close-modal" id="close-trip-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="date-selector">
                    <label>Last <input type="number" id="trip-days" value="7" min="1" max="30"> days</label>
                    <button id="load-trips">Load Trips</button>
                </div>
                <div id="trip-list" class="trip-list">
                    <p>Select a vehicle and load trips</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div class="modal hidden" id="add-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-car"></i> Add New Vehicle</h3>
                <button class="close-modal" id="close-add-vehicle">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="add-vehicle-form">
                    <div class="form-group">
                        <label for="vehicle-imei">IMEI / Device ID *</label>
                        <input type="text" id="vehicle-imei" required placeholder="e.g., 359710048216253">
                        <small>Enter the tracker's IMEI number</small>
                    </div>
                    <div class="form-group">
                        <label for="vehicle-name">Vehicle Name</label>
                        <input type="text" id="vehicle-name" placeholder="e.g., Toyota Hilux - AXK 1234">
                        <small>Optional: Give this vehicle a friendly name</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancel-add-vehicle">Cancel</button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-plus-circle"></i> Add Vehicle
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="app.js"></script>
</body>

</html>